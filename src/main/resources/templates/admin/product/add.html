<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/admin/layout.html}">
<head>
    <title>Thêm Sản Phẩm</title>
</head>

<body>
    <div layout:fragment="content" class="content container-fluid">
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script th:src="@{/admin/js/auth/check-role.js}"></script>
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-sm mb-2 mb-sm-0">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb breadcrumb-no-gutter">
                            <li class="breadcrumb-item"><a class="breadcrumb-link" href="ecommerce-products.html">Sản Phẩm</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Thêm Sản Phẩm</li>
                        </ol>
                    </nav>

                    <h1 class="page-header-title">Thêm Sản Phẩm</h1>
                </div>
            </div>
        </div>

        <div class="row">

            <div class="col-lg-8">

                <div class="card mb-3 mb-lg-5">
                    <!-- Header -->
                    <div class="card-header">
                        <h4 class="card-header-title">Thông tin sản phẩm</h4>
                    </div>
                    <!-- End Header -->

                    <!-- Body -->
                    <div class="card-body">

                        <!-- Name -->
                        <div class="form-group">
                            <label for="name" class="input-label">Tên</label>
                            <input type="text" class="form-control" id="name" placeholder="Nhẫn nam đính đá màu" aria-label="Nhẫn nam đính đá màu">
                            <span id="error-name" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                        </div>
                        <!-- End Name -->

                        <!-- SKU, GoldWeight, Quantity -->
                        <div class="row">
                            <div class="col-sm-6">
                                <!-- Form Group -->
                                <div class="form-group">
                                    <label for="sku" class="input-label">SKU</label>
                                    <input type="text" class="form-control" id="sku" placeholder="N001" aria-label="N001">
                                    <span id="error-sku" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                                </div>
                                <!-- End Form Group -->
                            </div>

                            <div class="col-sm-3">
                                <!-- Form Group -->
                                <div class="form-group">
                                    <label for="goldWeight" class="input-label">Trọng lượng</label>
                                    <div class="input-group input-group-merge">
                                        <input type="text" class="form-control" id="goldWeight" placeholder="0.0" aria-label="0.0">
                                        <div class="input-group-append">
                                            <!-- Select -->
                                            <div id="weightSelect" class="select2-custom select2-custom-right">
                                                <select class="js-select2-custom custom-select" size="1" style="opacity: 0;" data-hs-select2-options='{
                                          "dropdownParent": "#weightSelect",
                                          "dropdownAutoWidth": true,
                                          "width": true
                                        }'>
                                                    <option value="lb">lb</option>
                                                    <option value="oz">oz</option>
                                                    <option value="kg" selected="">kg</option>
                                                    <option value="g">g</option>
                                                </select>
                                            </div>
                                            <!-- End Select -->
                                        </div>
                                    </div>
                                    <span id="error-goldWeight" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                                </div>
                                <!-- End Form Group -->
                            </div>

                            <div class="col-sm-3">
                                <label for="quantity" class="input-label">Số lượng</label>
                                <div style="width: 100%;" class="js-quantity-counter input-group-quantity-counter">
                                    <input type="number" id="quantity" class="js-result form-control input-group-quantity-counter-control" value="0">

                                    <div class="input-group-quantity-counter-toggle">
                                        <a class="js-minus input-group-quantity-counter-btn" href="javascript:;">
                                            <i class="tio-remove"></i>
                                        </a>
                                        <a class="js-plus input-group-quantity-counter-btn" href="javascript:;">
                                            <i class="tio-add"></i>
                                        </a>
                                    </div>
                                </div>
                                <span id="error-quantity" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                            </div>
                        </div>
                        <!-- End SKU, GoldWeight, Quantity -->

                        <!-- Cost Price, Price -->
                        <div class="row">

                            <!-- Cost Price -->
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="costPrice" class="input-label">Giá vốn</label>

                                    <div class="input-group">
                                        <input type="text" class="form-control" id="costPrice" placeholder="0.00" aria-label="0.00">

                                        <div class="input-group-append">
                                            <!-- Select -->
                                            <div id="priceSelect" class="select2-custom select2-custom-right">
                                                <select class="js-select2-custom custom-select" size="1" style="opacity: 0;" data-hs-select2-options='{
                                                    "dropdownParent": "#priceSelect",
                                                    "dropdownAutoWidth": true,
                                                    "width": true
                                                }'>
                                                    <option value="USD" selected="">VNĐ</option>
                                                </select>
                                            </div>
                                            <!-- End Select -->
                                        </div>
                                    </div>
                                    <span id="error-costPrice" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                                </div>
                            </div>
                            <!-- End Cost Price -->

                            <!-- Price -->
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="price" class="input-label">Giá bán</label>

                                    <div class="input-group">
                                        <input type="text" class="form-control" id="price" placeholder="0.00" aria-label="0.00">

                                        <div class="input-group-append">
                                            <!-- Select -->
                                            <div id="priceSelect1" class="select2-custom select2-custom-right">
                                                <select class="js-select2-custom custom-select" size="1" style="opacity: 0;" data-hs-select2-options='{
                                                    "dropdownParent": "#priceSelect1",
                                                    "dropdownAutoWidth": true,
                                                    "width": true
                                                }'>
                                                    <option value="USD" selected="">VNĐ</option>
                                                </select>
                                            </div>
                                            <!-- End Select -->
                                        </div>
                                    </div>
                                    <span id="error-price" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                                </div>
                            </div>
                            <!-- End Price -->

                        </div>
                        <!-- End Cost Price, Price -->

                        <label class="input-label">Mô tả <span class="input-label-secondary">(Tùy chọn)</span></label>
                        <!-- Description -->
                        <div class="quill-custom">
                            <div class="js-quill" style="min-height: 15rem;" data-hs-quill-options='{
                              "placeholder": "Nhập mô tả sản phẩm..."
                            }'>
                            </div>
                        </div>
                        <!-- End Description -->

                    </div>
                </div>

                <!-- Image -->
                <div class="card mb-3 mb-lg-5">
                    <div class="card-header">
                        <h4 class="card-header-title">Hình ảnh</h4>
                    </div>

                    <div class="card-body">
                        <!-- Dropzone -->
                        <div id="images" class="js-dropzone dropzone-custom custom-file-boxed">
                            <div class="dz-message custom-file-boxed-label">
                                <img class="avatar avatar-xl avatar-4by3 mb-3" th:src="@{/admin/svg/illustrations/browse.svg}" alt="Image Description">
                                <h5 class="mb-1">Kéo và thả ảnh của sản phẩm vào đây</h5>
                                <p class="mb-2">hoặc</p>
                                <span class="btn btn-sm btn-primary">Chọn ảnh</span>
                            </div>
                        </div>
                        <!-- End Dropzone -->
                    </div>
                </div>
                <!-- End Image -->

            </div>

            <div class="col-lg-4">

                <!-- Avatar -->
                <div class="card mb-3 mb-lg-5">
                    <div class="card-header">
                        <h4 class="card-header-title">Ảnh đại diện</h4>
                    </div>

                    <div class="card-body">
                        <!-- Dropzone -->
                        <div id="avatar" class="js-dropzone dropzone-custom custom-file-boxed"
                             data-hs-dropzone-options='{
                                "maxFiles": 1
                             }'>
                            <div class="dz-message custom-file-boxed-label">
                                <img class="avatar avatar-xl avatar-4by3 mb-3" th:src="@{/admin/svg/illustrations/browse.svg}" alt="Image Description">
                                <h5 class="mb-1">Kéo và thả ảnh đại diện của sản phẩm vào đây</h5>
                                <p class="mb-2">hoặc</p>
                                <span class="btn btn-sm btn-primary">Chọn ảnh đại diện</span>
                            </div>
                        </div>
                        <!-- End Dropzone -->
                        <span id="error-avatar" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                    </div>
                </div>
                <!-- End Avatar -->

                <!-- Category -->
                <div class="card mb-3 mb-lg-5">
                    <div class="card-header">
                        <h4 class="card-header-title">Loại sản phẩm</h4>
                    </div>

                    <div class="card-body">
                        <div class="form-group">
                            <select class="js-select2-custom custom-select" size="1" style="opacity: 0;" id="categoryCode" data-hs-select2-options='{
                                        "placeholder": "Chọn loại sản phẩm",
                                        "searchInputPlaceholder": "Chọn loại sản phẩm"
                                    }'>
                                <option label="empty"></option>
                            </select>
                            <span id="error-categoryCode" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                        </div>

                    </div>
                </div>
                <!-- End Category -->

                <!-- Gold Type -->
                <div class="card mb-3 mb-lg-5">
                    <div class="card-header">
                        <h4 class="card-header-title">Loại vàng</h4>
                    </div>

                    <div class="card-body">
                        <div class="form-group">
                            <select class="js-select2-custom custom-select" size="1" style="opacity: 0;" id="goldType" data-hs-select2-options='{
                                        "placeholder": "Chọn loại vàng",
                                        "searchInputPlaceholder": "Chọn loại vàng"
                                    }'>
                                <option label="empty"></option>
                            </select>
                            <span id="error-goldType" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                        </div>
                    </div>
                </div>
                <!-- End Gold Type -->

                <!-- Supplier -->
                <div class="card mb-3 mb-lg-5">
                    <div class="card-header">
                        <h4 class="card-header-title">Nhà cung cấp</h4>
                    </div>

                    <div class="card-body">
                        <div class="form-group">
                            <select class="js-select2-custom custom-select" size="1" style="opacity: 0;" id="supplierCode" data-hs-select2-options='{
                                "placeholder": "Chọn nhà cung cấp",
                                "searchInputPlaceholder": "Chọn nhà cung cấp"
                            }'>
                                <option label="empty"></option>
                            </select>
                            <span id="error-supplierCode" style="color: #ff0000; display: none; margin-top: 5px;"></span>
                        </div>
                    </div>
                </div>
                <!-- End Supplier -->

            </div>
        </div>

        <div class="position-fixed bottom-0 content-centered-x w-100 z-index-99 mb-3" style="max-width: 40rem;">
            <!-- Card -->
            <div class="card card-sm bg-dark border-dark mx-2">
                <div class="card-body">
                    <div class="row justify-content-center justify-content-sm-around">
                        <div class="col-auto">
                            <button type="button" class="btn btn-secondary">Lưu nháp</button>
                        </div>
                        <div class="col-auto">
                            <button id="submit" type="button" class="btn btn-primary">Lưu</button>
                        </div>
                    </div>
                    <!-- End Row -->
                </div>
            </div>
            <!-- End Card -->
        </div>
    </div>

    <th:block layout:fragment="script">

        <script th:src="@{/admin/js/product/add.js}"></script>

        <script>

            $(async function () {

                const getCategories = axios.get(baseUrl + "/products/categories");
                const getGoldTypes = axios.get(baseUrl + "/products/gold-types");
                const getSuppliers = axios.get(baseUrl + "/suppliers");

                await axios.all([getCategories, getGoldTypes, getSuppliers])
                    .then(axios.spread((categories, goldTypes, suppliers) => {
                        let category = categories.data.content.map((category) => {
                            return renderCategory(category);
                        }).join(' ');
                        $('#categoryCode').append(category);

                        let goldType = goldTypes.data.content.map((goldType) => {
                            return renderGoldType(goldType);
                        }).join(' ');
                        $('#goldType').append(goldType);

                        let supplier = suppliers.data.content.map((supplier) => {
                            return renderSupplier(supplier);
                        }).join(' ');
                        $('#supplierCode').append(supplier);

                    }));
            });

            $(window).load(() => {
                const toastMessages = sessionStorage.getItem('toastMessages');
                if(toastMessages) {
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-right',
                        iconColor: 'white',
                        customClass: {
                            popup: 'colored-toast'
                        },
                        showConfirmButton: false,
                        timer: 4000,
                        timerProgressBar: true
                    });
                    Toast.fire({
                        icon: 'success',
                        title: 'Thêm sản phẩm thành công'
                    })
                }
                sessionStorage.removeItem('toastMessages');
            })

            $('#submit').on('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();

                Swal.fire({
                    title: 'Vui lòng đợi!',
                    icon: 'info',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const imagesDropzone = Dropzone.forElement('#images');
                const images = imagesDropzone.getQueuedFiles();

                const avatarDropzone = Dropzone.forElement('#avatar');
                const avatar = avatarDropzone.getQueuedFiles()[0];

                const dto = {
                    sku: $('#sku').val(),
                    name: $('#name').val(),
                    description: $('.ql-editor').html(),
                    goldWeight: $('#goldWeight').val(),
                    costPrice: $('#costPrice').val(),
                    price: $('#price').val(),
                    quantity: $('#quantity').val(),
                    supplierCode: $('#supplierCode').val(),
                    categoryCode: $('#categoryCode').val(),
                    goldType: $('#goldType').val(),
                    images: null,
                    avatar: null
                }

                const errors = validation(dto, avatar);
                if(errors === null) {
                    const formData = new FormData();

                    formData.append('dto', new Blob([JSON.stringify(dto)], {type: "application/json"}));

                    if(avatar != null) {
                        formData.append('avatar', avatar);
                    }

                    if(images != null) {
                        images.map((image) => {
                            formData.append('images[]', image);
                        });
                    }

                    await axios.post(baseUrl + '/products', formData)
                        .then((res) => {
                            if(res.status === 200) {
                                sessionStorage.setItem('toastMessages', true);
                                window.location.reload();
                            }
                        })
                        .catch((error) => {
                            const status = error.response.status;

                            if(status === 500 || status === 400){
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Đã có lỗi xảy ra',
                                    text: 'Vui lòng kiểm tra lại thông tin!',
                                    confirmButtonColor: '#377dff',
                                    confirmButtonText: 'Đồng ý!'
                                });
                                removeError();
                                addErrorToMap(error.response.data.errors);
                                renderError();
                            }
                        });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Đã có lỗi xảy ra',
                        text: 'Vui lòng kiểm tra lại thông tin!',
                        showConfirmButton: true,
                        confirmButtonColor: '#377dff',
                        confirmButtonText: 'Đồng ý!',
                        didOpen: () => {
                            Swal.hideLoading();
                        }
                    });
                    removeError();
                    addErrorToMap(errors);
                    renderError();
                }

            });

        </script>

    </th:block>
</body>
</html>